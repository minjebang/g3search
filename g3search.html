<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Three-Column Google Search</title>
  <style>
    /* ====== THEME (light/dark) via CSS variables ====== */
    :root {
      --bg: #0b0c0f;
      --panel: #11131a;
      --text: #e7e9ee;
      --muted: #9aa3b2;
      --accent: #5aa8ff;
      --accent-2: #7c5cff;
      --input-bg: #0e1016;
      --border: #1a1e27;
      --chip: #0f1625;
      --chip-text: #cbd3e3;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .light {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --text: #0e1320;
      --muted: #4b5565;
      --accent: #2b6bff;
      --accent-2: #7c5cff;
      --input-bg: #f1f4f9;
      --border: #e6e9f0;
      --chip: #eef3ff;
      --chip-text: #1f3463;
      --shadow: 0 8px 24px rgba(9, 20, 66, .08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(124,92,255,.16), transparent 60%),
                  radial-gradient(800px 600px at 10% -10%, rgba(90,168,255,.16), transparent 60%),
                  var(--bg);
      color: var(--text);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* ====== Header / Search bar ====== */
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header {
      position: sticky; top: 0; z-index: 5;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--border);
    }
    .bar { display:flex; align-items:center; gap:10px; padding:14px 0; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; }
    .brand .dot { width:10px; height:10px; border-radius:50%; background:conic-gradient(from 90deg, var(--accent), var(--accent-2)); box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 24%, transparent); }

    .search {
      flex:1; display:flex; align-items:center; gap:10px;
      border:1px solid var(--border); border-radius:14px; padding:10px 12px; background: var(--input-bg);
      box-shadow: var(--shadow);
    }
    .search input[type="text"]{
      flex:1; appearance:none; background:transparent; border:0; outline:0; color:var(--text);
      font-size:16px; padding:6px; min-width:0;
    }
    .btn { appearance:none; border:1px solid var(--border); background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 20%, transparent), transparent 60%); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; transition: transform .08s ease, opacity .2s ease, background .2s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn.primary { background: linear-gradient(180deg, var(--accent), color-mix(in oklab, var(--accent) 60%, black)); border-color: color-mix(in oklab, var(--accent) 40%, black); color:white; }
    .icon-btn { width:40px; height:40px; display:grid; place-items:center; border-radius:12px; background: var(--panel); border:1px solid var(--border); cursor:pointer; box-shadow: var(--shadow); }
    .chip { font-size:12px; padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--chip-text); border:1px solid var(--border); }
    .muted { color:var(--muted); }

    /* ====== Columns ====== */
    .results-wrap { max-width: 1400px; margin: 12px auto 28px; padding: 0 20px 28px; display:none; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; }

    .col { background: var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow: var(--shadow); min-height: 180px; display:flex; flex-direction:column; }
    .col header { position:relative; top:auto; backdrop-filter:none; background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 80%, transparent), transparent); border-bottom:1px solid var(--border); }
    .col header .h { display:flex; align-items:center; gap:10px; padding:12px 14px; font-weight:700; }
    .col header .h svg { width:18px; height:18px; opacity:.9; }

    .scroll { overflow:auto; max-height: calc(100vh - 170px); padding: 10px; }

    .card { display:block; padding:12px; border:1px solid transparent; border-radius:10px; text-decoration:none; color:inherit; transition: background .15s ease, border-color .15s ease, transform .08s ease; }
    .card:hover { background: color-mix(in oklab, var(--panel) 92%, var(--accent) 8%); border-color: color-mix(in oklab, var(--accent) 40%, var(--border)); transform: translateY(-1px); }
    .card h4 { margin:0 0 6px; font-size:15px; line-height:1.35; }
    .card p { margin:0; color:var(--muted); font-size:13px; }
    .small { font-size:12px; opacity:.9; }

    .thumb-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
    .thumb { display:block; border-radius:10px; overflow:hidden; border:1px solid var(--border); }
    .thumb img { width:100%; height:140px; object-fit:cover; display:block; }

    .video { display:flex; gap:10px; padding:12px; border-radius:10px; border:1px solid transparent; color:inherit; text-decoration:none; }
    .video:hover { background: color-mix(in oklab, var(--panel) 92%, var(--accent-2) 8%); border-color: color-mix(in oklab, var(--accent-2) 40%, var(--border)); }
    .video .vthumb { width:160px; flex:0 0 160px; aspect-ratio:16/9; border-radius:10px; overflow:hidden; border:1px solid var(--border); }
    .video .vthumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .video .meta { min-width:0; }
    .video h4{ margin:0 0 6px; font-size:15px; line-height:1.35; }
    .video .meta .small { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* ====== Empty / Loading ====== */
    .empty { padding:16px; color:var(--muted); }
    .loader { display:flex; gap:10px; align-items:center; padding:14px; }
    .spinner { width:16px; height:16px; border-radius:50%; border:2px solid color-mix(in oklab, var(--text) 20%, transparent); border-top-color: var(--accent); animation: spin .9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg) } }

    /* ====== Responsive ====== */
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 760px)  { .grid { grid-template-columns: 1fr; } .video .vthumb { width:120px; flex-basis: 120px; } }
  </style>
</head>
<body class="light">
  <header>
    <div class="wrap bar">
      <div class="brand" aria-label="App brand">
        <div class="dot" aria-hidden="true"></div>
        <div>3× Google Search</div>
        <span class="chip" id="statusChip">Ready</span>
      </div>

      <form class="search" id="searchForm" autocomplete="off" role="search" aria-label="Search Google">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-3.5-3.5M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="q" type="text" placeholder="Search Google… (press Enter)" aria-label="Search query" />
        <button class="btn primary" type="submit" id="goBtn">Search</button>
        <button class="btn" type="button" id="clearBtn" title="Clear">Clear</button>
      </form>

      <button class="icon-btn" id="themeBtn" title="Toggle light/dark" aria-label="Toggle light/dark">
        <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 4V2M12 22v-2M4.93 4.93 3.52 3.52M20.48 20.48l-1.41-1.41M4 12H2m20 0h-2M4.93 19.07 3.52 20.48M20.48 3.52l-1.41 1.41" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.6"/></svg>
        <svg id="moonIcon" style="display:none" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20.354 15.354A9 9 0 1 1 8.646 3.646 7 7 0 0 0 20.354 15.354Z" stroke="currentColor" stroke-width="1.6"/></svg>
      </button>
    </div>
  </header>

  <main class="results-wrap" id="resultsWrap" aria-live="polite">
    <div class="grid">
      <!-- Web Column -->
      <section class="col" id="colWeb">
        <header><div class="h"> 
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6"/><path d="M3 12h18M12 3c3 3.6 3 14.4 0 18M5 7h14M5 17h14" stroke="currentColor" stroke-width="1.2"/></svg>
          Web
        </div></header>
        <div class="scroll" id="webResults"></div>
      </section>

      <!-- Images Column -->
      <section class="col" id="colImages">
        <header><div class="h">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.6"/><path d="m8 14 2.2-2.2a1 1 0 0 1 1.6.2l1.4 2.1 1.2-1.3a1 1 0 0 1 1.6.2L19 16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          Images
        </div></header>
        <div class="scroll" id="imageResults"></div>
      </section>

      <!-- Videos Column -->
      <section class="col" id="colVideos">
        <header><div class="h">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.6"/><path d="M10 9.5v5l4-2.5-4-2.5Z" fill="currentColor"/></svg>
          Videos
        </div></header>
        <div class="scroll" id="videoResults"></div>
      </section>
    </div>
  </main>

  <script>
    // ================== CONFIG: Insert your keys here ==================
    const CONFIG = {
      GOOGLE_CSE_KEY: "", // <- REQUIRED
      GOOGLE_CSE_CX:  "", // <- REQUIRED (Search engine ID)
      YOUTUBE_API_KEY: ""  // <- REQUIRED for the Videos column
    };

    // ================== DOM helpers ==================
    const $ = sel => document.querySelector(sel);
    const webBox = $('#webResults');
    const imgBox = $('#imageResults');
    const vidBox = $('#videoResults');
    const resWrap = $('#resultsWrap');
    const statusChip = $('#statusChip');
    const qInput = $('#q');
    const form = $('#searchForm');
    const clearBtn = $('#clearBtn');
    const themeBtn = $('#themeBtn');
    const sunIcon = $('#sunIcon');
    const moonIcon = $('#moonIcon');

    let currentQuery = '';
    let inFlight = [];

    // Pagination state for infinite scroll
    const paging = {
      web:   { start: 1, num: 10, loading: false, done: false },   // CSE uses 1-based start
      image: { start: 1, num: 10, loading: false, done: false },
      video: { pageToken: null, loading: false, done: false }
    };

    function setStatus(text){ statusChip.textContent = text; }
    function showResultsArea(show) { resWrap.style.display = show ? 'block' : 'none'; }

    function resetColumns(){
      [webBox, imgBox, vidBox].forEach(el => el.innerHTML = '');
    }
    function resetPaging(){
      paging.web =   { start: 1, num: 10, loading: false, done: false };
      paging.image = { start: 1, num: 10, loading: false, done: false };
      paging.video = { pageToken: null, loading: false, done: false };
    }
    function abortInFlight(){
      inFlight.forEach(c => { try { c.abort(); } catch(_){} });
      inFlight = [];
    }

    function ensureKeys(){
      const missing = [];
      if(!CONFIG.GOOGLE_CSE_KEY) missing.push('GOOGLE_CSE_KEY');
      if(!CONFIG.GOOGLE_CSE_CX)  missing.push('GOOGLE_CSE_CX');
      if(!CONFIG.YOUTUBE_API_KEY) missing.push('YOUTUBE_API_KEY');
      return missing;
    }

    function renderLoader(target, label){
      const div = document.createElement('div');
      div.className = 'loader';
      div.dataset.loader = 'true';
      div.innerHTML = `<div class="spinner" aria-hidden="true"></div><span>${label}</span>`;
      target.appendChild(div);
      return div;
    }

    function removeExistingLoader(target){
      const last = Array.from(target.querySelectorAll('[data-loader]')).pop();
      if(last) last.remove();
    }

    function renderEmpty(target, text){
      const div = document.createElement('div');
      div.className = 'empty';
      div.textContent = text;
      target.appendChild(div);
      return div;
    }

    // ================== Search actions ==================
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const q = qInput.value.trim();
      if(!q) return;
      doSearch(q);
    });

    clearBtn.addEventListener('click', () => {
      qInput.value = '';
      abortInFlight();
      resetColumns();
      showResultsArea(false);
      setStatus('Ready');
      qInput.focus();
    });

    // When the user modifies the search after results are displayed, remove all columns and wait again
    qInput.addEventListener('input', () => {
      if(resWrap.style.display === 'block') {
        abortInFlight();
        resetColumns();
        showResultsArea(false);
        setStatus('Editing…');
      }
    });

    // Keyboard niceties
    qInput.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') {
        clearBtn.click();
      }
    });

    async function doSearch(q){
      currentQuery = q;
      setStatus('Searching…');
      showResultsArea(true);
      resetColumns();
      resetPaging();
      abortInFlight();

      const missing = ensureKeys();
      if(missing.length) {
        const tip = `Add your API keys (${missing.join(', ')}) in the CONFIG at the top of the file.`;
        renderEmpty(webBox, tip);
        renderEmpty(imgBox, tip);
        renderEmpty(vidBox, tip);
      }

      // Initial page for each column
      await Promise.all([
        fetchWeb(q, /*append*/ false),
        fetchImages(q, /*append*/ false),
        fetchVideos(q, /*append*/ false)
      ]);

      setStatus('Done');

      // Attach infinite scroll listeners (once per search)
      attachInfiniteScroll(webBox,   () => fetchWeb(currentQuery, true));
      attachInfiniteScroll(imgBox,   () => fetchImages(currentQuery, true));
      attachInfiniteScroll(vidBox,   () => fetchVideos(currentQuery, true));
    }

    function attachInfiniteScroll(container, onNeedMore){
      container.addEventListener('scroll', () => {
        const nearBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 120;
        if(nearBottom) onNeedMore();
      });
    }

    // ================== Column fetchers ==================
    async function fetchWeb(q, append = true){
      if(paging.web.loading || paging.web.done) return;
      paging.web.loading = true;

      if(!append) webBox.innerHTML = '';
      removeExistingLoader(webBox);
      const loader = renderLoader(webBox, append ? 'Loading more…' : 'Loading web results…');

      const aborter = new AbortController();
      inFlight.push(aborter);
      try {
        if(!CONFIG.GOOGLE_CSE_KEY || !CONFIG.GOOGLE_CSE_CX) throw new Error('Missing Google CSE key/cx');
        const url = new URL('https://www.googleapis.com/customsearch/v1');
        url.searchParams.set('key', CONFIG.GOOGLE_CSE_KEY);
        url.searchParams.set('cx', CONFIG.GOOGLE_CSE_CX);
        url.searchParams.set('q', q);
        url.searchParams.set('num', String(paging.web.num));
        url.searchParams.set('start', String(paging.web.start)); // 1-based

        const res = await fetch(url, { signal: aborter.signal });
        if(!res.ok) throw new Error('Web search failed: ' + res.status);
        const data = await res.json();

        loader.remove();
        const items = data.items || [];
        if(items.length === 0 && !append) return renderEmpty(webBox, 'No web results.');
        for (const it of items) {
          const a = document.createElement('a');              // <-- create it
          a.className = 'card';
          a.href = it.link;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';

          const snippet = (it.snippet || '')
            .replace(/\\n|\n/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();

          a.innerHTML = `<h4>${escapeHtml(it.title || it.link)}</h4>
                        <p>${escapeHtml(snippet)}</p>
                        <div class="small muted">${escapeHtml(it.displayLink || '')}</div>`;
          webBox.appendChild(a);
        }


        // Advance or finish
        const next = data.queries?.nextPage?.[0]?.startIndex;
        if(next) {
          paging.web.start = next;
        } else {
          // If API didn't provide nextPage, infer done when fewer than requested returned
          if(items.length < paging.web.num || paging.web.start >= 91) paging.web.done = true; // CSE max ~100 results
        }
      } catch (err) {
        try { loader.remove(); } catch(_){}
        if(err.name !== 'AbortError') renderEmpty(webBox, 'Web: ' + err.message);
      } finally {
        paging.web.loading = false;
      }
    }

    async function fetchImages(q, append = true){
      if(paging.image.loading || paging.image.done) return;
      paging.image.loading = true;

      if(!append) imgBox.innerHTML = '';
      removeExistingLoader(imgBox);
      const loader = renderLoader(imgBox, append ? 'Loading more…' : 'Loading images…');

      const aborter = new AbortController();
      inFlight.push(aborter);
      try {
        if(!CONFIG.GOOGLE_CSE_KEY || !CONFIG.GOOGLE_CSE_CX) throw new Error('Missing Google CSE key/cx');
        const url = new URL('https://www.googleapis.com/customsearch/v1');
        url.searchParams.set('key', CONFIG.GOOGLE_CSE_KEY);
        url.searchParams.set('cx', CONFIG.GOOGLE_CSE_CX);
        url.searchParams.set('q', q);
        url.searchParams.set('searchType', 'image');
        url.searchParams.set('num', String(paging.image.num));
        url.searchParams.set('start', String(paging.image.start));

        const res = await fetch(url, { signal: aborter.signal });
        if(!res.ok) throw new Error('Image search failed: ' + res.status);
        const data = await res.json();

        loader.remove();
        const items = data.items || [];
        if(items.length === 0 && !append) return renderEmpty(imgBox, 'No image results.');

        // Ensure we have a grid container for thumbnails
        let grid = imgBox.querySelector('.thumb-grid');
        if(!grid){ grid = document.createElement('div'); grid.className = 'thumb-grid'; imgBox.appendChild(grid); }

        for(const it of items){
          const ctx = it.image?.contextLink || it.link;
          const a = document.createElement('a');
          a.className = 'thumb'; a.href = ctx; a.target = '_blank'; a.rel = 'noopener noreferrer';
          a.title = it.title || 'Open image source';
          const img = document.createElement('img');
          img.loading = 'lazy'; img.src = it.link; img.alt = it.title || 'Image result';
          a.appendChild(img); grid.appendChild(a);
        }

        const next = data.queries?.nextPage?.[0]?.startIndex;
        if(next) {
          paging.image.start = next;
        } else {
          if(items.length < paging.image.num || paging.image.start >= 91) paging.image.done = true;
        }
      } catch (err) {
        try { loader.remove(); } catch(_){}
        if(err.name !== 'AbortError') renderEmpty(imgBox, 'Images: ' + err.message);
      } finally {
        paging.image.loading = false;
      }
    }

    async function fetchVideos(q, append = true){
      if(paging.video.loading || paging.video.done) return;
      paging.video.loading = true;

      if(!append) vidBox.innerHTML = '';
      removeExistingLoader(vidBox);
      const loader = renderLoader(vidBox, append ? 'Loading more…' : 'Loading videos…');

      const aborter = new AbortController();
      inFlight.push(aborter);
      try {
        if(!CONFIG.YOUTUBE_API_KEY) throw new Error('Missing YOUTUBE_API_KEY');
        const url = new URL('https://www.googleapis.com/youtube/v3/search');
        url.searchParams.set('part', 'snippet');
        url.searchParams.set('type', 'video');
        url.searchParams.set('maxResults', '12');
        url.searchParams.set('q', q);
        if(paging.video.pageToken) url.searchParams.set('pageToken', paging.video.pageToken);
        url.searchParams.set('key', CONFIG.YOUTUBE_API_KEY);

        const res = await fetch(url, { signal: aborter.signal });
        if(!res.ok) throw new Error('YouTube search failed: ' + res.status);
        const data = await res.json();

        loader.remove();
        const items = data.items || [];
        if(items.length === 0 && !append) return renderEmpty(vidBox, 'No video results.');

        for(const it of items){
          const id = it.id?.videoId;
          const s = it.snippet || {};
          const href = `https://www.youtube.com/watch?v=${id}`;
          const a = document.createElement('a');
          a.className = 'video'; a.href = href; a.target = '_blank'; a.rel = 'noopener noreferrer';
          a.innerHTML = `
            <div class="vthumb"><img loading="lazy" src="${thumbUrl(s.thumbnails)}" alt="${escapeHtml(s.title || 'Video thumbnail')}"/></div>
            <div class="meta">
              <h4>${escapeHtml(s.title || 'Untitled')}</h4>
              <div class="small muted">${escapeHtml(s.channelTitle || '')}</div>
              <p class="small">${escapeHtml(s.description || '').slice(0, 140)}${(s.description||'').length>140?'…':''}</p>
            </div>`;
          vidBox.appendChild(a);
        }

        // Handle next page token
        if(data.nextPageToken){
          paging.video.pageToken = data.nextPageToken;
        } else {
          paging.video.done = true;
        }
      } catch (err) {
        try { loader.remove(); } catch(_){}
        if(err.name !== 'AbortError') renderEmpty(vidBox, 'Videos: ' + err.message);
      } finally {
        paging.video.loading = false;
      }
    }

    function thumbUrl(th){
      if(!th) return '';
      return (th.medium?.url) || (th.high?.url) || (th.default?.url) || '';
    }

    // ================== Theme toggle (persisted) ==================
    function applyTheme(mode){
      const b = document.body;
      if(mode === 'dark') { b.classList.remove('light'); } else { b.classList.add('light'); }
      sunIcon.style.display = (mode === 'dark') ? 'none' : '';
      moonIcon.style.display = (mode === 'dark') ? '' : 'none';
      localStorage.setItem('search3_theme', mode);
    }
    function toggleTheme(){
      const isLight = document.body.classList.contains('light');
      applyTheme(isLight ? 'dark' : 'light');
    }
    themeBtn.addEventListener('click', toggleTheme);
    applyTheme(localStorage.getItem('search3_theme') || 'light');

    // ================== Utils ==================
    function escapeHtml(s){
      return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
  </script>
</body>
</html>
